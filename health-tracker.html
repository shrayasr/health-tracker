<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* ========================================
           RESET & BASE STYLES
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ========================================
           HEADER
           ======================================== */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            padding: 1rem;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* ========================================
           LAYOUT CONTAINERS
           ======================================== */
        .main-layout {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        /* ========================================
           FORM STYLES
           ======================================== */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* BP inputs grid - responsive based on screen size */
        .bp-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        .dynamic-fields {
            display: none;
        }

        .dynamic-fields.active {
            display: block;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }

        .btn-muted {
            background: #9ca3af;
            color: white;
        }

        .btn-muted:hover {
            background: #6b7280;
        }

        .btn-muted-action {
            background: #d1d5db;
            color: #4b5563;
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn-muted-action:hover {
            background: #9ca3af;
            color: white;
        }

        /* ========================================
           TABLE STYLES
           ======================================== */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f7fafc;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f7fafc;
        }

        .void-row {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .actions-cell {
            white-space: nowrap;
        }

        /* ========================================
           BADGES
           ======================================== */
        .void-badge {
            background: #fc8181;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .type-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .type-bp {
            background: #bee3f8;
            color: #2c5282;
        }

        .type-sugar {
            background: #fbd38d;
            color: #744210;
        }

        /* ========================================
           CHARTS
           ======================================== */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }

        /* ========================================
           EMPTY STATE
           ======================================== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
        }

        /* ========================================
           RESPONSIVE STYLES
           ======================================== */

        /* Mobile screens (< 768px) */
        @media (max-width: 767px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 1rem;
            }

            .bp-inputs {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 0.5rem;
            }

            .btn-small {
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
            }

            .btn-muted-action {
                padding: 0.3rem 0.6rem;
                font-size: 0.7rem;
            }

            .chart-container {
                height: 250px;
            }
        }

        /* Tablet screens (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .bp-inputs {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        /* Desktop/Laptop screens (>= 1024px) - SPLIT LAYOUT */
        @media (min-width: 1024px) {
            .main-layout {
                display: grid;
                grid-template-columns: 30% 70%;
                gap: 1.5rem;
                align-items: start;
            }

            .form-card {
                position: sticky;
                top: 1rem;
                margin-bottom: 0;
            }

            .history-card {
                margin-bottom: 0;
            }

            /* BP inputs stack vertically in narrow sidebar */
            .bp-inputs {
                grid-template-columns: 1fr;
            }

            /* Larger charts in the wider history section */
            .chart-container {
                height: 350px;
            }
        }

        /* Extra large screens (>= 1440px) */
        @media (min-width: 1440px) {
            .container {
                max-width: 1600px;
            }

            .chart-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíä Health Tracker</h1>
            <p>Track your blood pressure and sugar levels</p>
        </div>

        <!-- Main Layout Container -->
        <div class="main-layout">
            <!-- Data Entry Form -->
            <div class="card form-card">
                <h2>üìù Record New Measurement</h2>
            <form id="healthForm">
                <div class="form-group">
                    <label for="personName">Person Name *</label>
                    <input type="text" id="personName" list="namesList" placeholder="Enter name" required autocomplete="off">
                    <datalist id="namesList">
                        <!-- Names will be populated here -->
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="measurementType">Measurement Type *</label>
                    <select id="measurementType" required>
                        <option value="">-- Select Type --</option>
                        <option value="bp">Blood Pressure (BP)</option>
                        <option value="sugar">Sugar Level</option>
                    </select>
                </div>

                <!-- BP Fields -->
                <div id="bpFields" class="dynamic-fields">
                    <div class="form-group">
                        <label>Blood Pressure & Pulse *</label>
                        <div class="bp-inputs">
                            <div>
                                <input type="number" id="systolic" placeholder="Systolic" min="0" max="300">
                                <small style="color: #999;">Top number</small>
                            </div>
                            <div>
                                <input type="number" id="diastolic" placeholder="Diastolic" min="0" max="200">
                                <small style="color: #999;">Bottom number</small>
                            </div>
                            <div>
                                <input type="number" id="pulse" placeholder="Pulse" min="0" max="250">
                                <small style="color: #999;">BPM</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sugar Fields -->
                <div id="sugarFields" class="dynamic-fields">
                    <div class="form-group">
                        <label for="sugarLevel">Sugar Level (mg/dL) *</label>
                        <input type="number" id="sugarLevel" placeholder="Enter sugar level" min="0" max="600">
                    </div>
                </div>

                <div class="form-group">
                    <label for="date">Date *</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label for="time">Time *</label>
                    <input type="time" id="time" required>
                </div>

                <div class="form-group">
                    <label for="remarks">Remarks</label>
                    <textarea id="remarks" placeholder="Any additional notes..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">Save Record</button>
            </form>
        </div>

            <!-- History View -->
            <div class="card history-card">
                <h2>üìä Health History</h2>

            <div style="text-align: right; margin-bottom: 1rem;">
                <button class="btn btn-muted btn-small" onclick="exportToCSV()">üíæ Export CSV</button>
            </div>

            <!-- Charts Section -->
            <div style="margin-bottom: 2rem;">
                <div class="chart-container">
                    <canvas id="bpChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="sugarChart"></canvas>
                </div>
            </div>

            <!-- Table Section -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="recordLimit" style="margin: 0; font-size: 0.9rem;">Show:</label>
                            <select id="recordLimit" onchange="updateRecordLimit()" style="width: auto; padding: 0.5rem;">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span style="font-size: 0.9rem; color: #666;">records</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="metricFilter" style="margin: 0; font-size: 0.9rem;">Filter:</label>
                            <select id="metricFilter" onchange="updateMetricFilter()" style="width: auto; padding: 0.5rem;">
                                <option value="all">All Types</option>
                                <option value="bp">BP Only</option>
                                <option value="sugar">Sugar Only</option>
                            </select>
                        </div>
                    </div>
                    <div id="recordCount" style="font-size: 0.9rem; color: #666;"></div>
                </div>

                <div class="table-wrapper">
                    <table id="recordsTable">
                        <thead>
                            <tr>
                                <th>Person</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Values</th>
                                <th>Remarks</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Records will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div> <!-- End main-layout -->
    </div>

    <script>
        // Global state
        let records = [];
        let editingId = null;
        let bpChart = null;
        let sugarChart = null;
        let recordLimit = 20;
        let metricFilter = 'all';
        let uniqueNames = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            loadUniqueNames();
            populateNamesList();
            setDefaultDateTime();
            setupEventListeners();
            renderTable();
            initCharts();
            updateCharts();
        });

        function setupEventListeners() {
            document.getElementById('measurementType').addEventListener('change', function(e) {
                const bpFields = document.getElementById('bpFields');
                const sugarFields = document.getElementById('sugarFields');

                if (e.target.value === 'bp') {
                    bpFields.classList.add('active');
                    sugarFields.classList.remove('active');
                    document.getElementById('systolic').required = true;
                    document.getElementById('diastolic').required = true;
                    document.getElementById('pulse').required = true;
                    document.getElementById('sugarLevel').required = false;
                } else if (e.target.value === 'sugar') {
                    sugarFields.classList.add('active');
                    bpFields.classList.remove('active');
                    document.getElementById('sugarLevel').required = true;
                    document.getElementById('systolic').required = false;
                    document.getElementById('diastolic').required = false;
                    document.getElementById('pulse').required = false;
                } else {
                    bpFields.classList.remove('active');
                    sugarFields.classList.remove('active');
                }
            });

            document.getElementById('healthForm').addEventListener('submit', handleSubmit);
        }

        function setDefaultDateTime() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0, 5);

            document.getElementById('date').value = date;
            document.getElementById('time').value = time;
        }

        function handleSubmit(e) {
            e.preventDefault();

            const personName = document.getElementById('personName').value.trim();
            const type = document.getElementById('measurementType').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const remarks = document.getElementById('remarks').value;

            let values = {};

            if (type === 'bp') {
                values = {
                    systolic: parseInt(document.getElementById('systolic').value),
                    diastolic: parseInt(document.getElementById('diastolic').value),
                    pulse: parseInt(document.getElementById('pulse').value)
                };
            } else if (type === 'sugar') {
                values = {
                    sugar: parseInt(document.getElementById('sugarLevel').value)
                };
            }

            const record = {
                id: editingId || Date.now(),
                personName: personName,
                type: type,
                date: date,
                time: time,
                values: values,
                remarks: remarks,
                isVoid: false
            };

            if (editingId) {
                // Update existing record
                const index = records.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    // Preserve void status when editing
                    record.isVoid = records[index].isVoid;
                    records[index] = record;
                }
                editingId = null;
                document.getElementById('submitBtn').textContent = 'Save Record';
            } else {
                // Add new record
                records.push(record);
            }

            // Update unique names list
            if (personName && !uniqueNames.includes(personName)) {
                uniqueNames.push(personName);
                saveUniqueNames();
                populateNamesList();
            }

            saveRecords();
            renderTable();
            updateCharts();
            resetForm();
        }

        function resetForm() {
            document.getElementById('healthForm').reset();
            document.getElementById('bpFields').classList.remove('active');
            document.getElementById('sugarFields').classList.remove('active');
            setDefaultDateTime();
            editingId = null;
            document.getElementById('submitBtn').textContent = 'Save Record';
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            editingId = id;

            document.getElementById('personName').value = record.personName || '';
            document.getElementById('measurementType').value = record.type;
            document.getElementById('measurementType').dispatchEvent(new Event('change'));

            if (record.type === 'bp') {
                document.getElementById('systolic').value = record.values.systolic;
                document.getElementById('diastolic').value = record.values.diastolic;
                document.getElementById('pulse').value = record.values.pulse;
            } else if (record.type === 'sugar') {
                document.getElementById('sugarLevel').value = record.values.sugar;
            }

            document.getElementById('date').value = record.date;
            document.getElementById('time').value = record.time;
            document.getElementById('remarks').value = record.remarks;

            document.getElementById('submitBtn').textContent = 'Update Record';

            // Scroll to form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function voidRecord(id) {
            const index = records.findIndex(r => r.id === id);
            if (index !== -1) {
                records[index].isVoid = !records[index].isVoid;
                saveRecords();
                renderTable();
                updateCharts();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const recordCountDiv = document.getElementById('recordCount');

            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>No records yet. Start by adding your first measurement!</p>
                            </div>
                        </td>
                    </tr>
                `;
                recordCountDiv.textContent = '';
                return;
            }

            // Sort by date and time (newest first)
            let sortedRecords = [...records].sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateB - dateA;
            });

            // Apply metric filter
            if (metricFilter !== 'all') {
                sortedRecords = sortedRecords.filter(r => r.type === metricFilter);
            }

            // Apply pagination - show last N records
            const displayRecords = sortedRecords.slice(0, recordLimit);

            // Update record count display
            const filterText = metricFilter === 'all' ? '' : ` (${metricFilter.toUpperCase()})`;
            if (sortedRecords.length > recordLimit) {
                recordCountDiv.textContent = `Showing last ${recordLimit} of ${sortedRecords.length} records${filterText}`;
            } else if (sortedRecords.length > 0) {
                recordCountDiv.textContent = `Showing all ${sortedRecords.length} records${filterText}`;
            } else {
                recordCountDiv.textContent = `No ${metricFilter.toUpperCase()} records found`;
            }

            tbody.innerHTML = displayRecords.map(record => {
                let valuesDisplay = '';
                if (record.type === 'bp') {
                    valuesDisplay = `${record.values.systolic}/${record.values.diastolic}, Pulse: ${record.values.pulse}`;
                } else if (record.type === 'sugar') {
                    valuesDisplay = `${record.values.sugar} mg/dL`;
                }

                const typeClass = record.type === 'bp' ? 'type-bp' : 'type-sugar';
                const typeLabel = record.type === 'bp' ? 'BP' : 'Sugar';

                return `
                    <tr class="${record.isVoid ? 'void-row' : ''}">
                        <td>${record.personName || '-'}</td>
                        <td>${record.date}</td>
                        <td>${record.time}</td>
                        <td><span class="type-badge ${typeClass}">${typeLabel}</span></td>
                        <td>${valuesDisplay}</td>
                        <td>${record.remarks || '-'}</td>
                        <td>${record.isVoid ? '<span class="void-badge">VOID</span>' : '-'}</td>
                        <td class="actions-cell">
                            <button class="btn btn-secondary btn-small" onclick="editRecord(${record.id})">Edit</button>
                            <button class="btn btn-muted-action" onclick="voidRecord(${record.id})">
                                ${record.isVoid ? 'Unvoid' : 'Void'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateRecordLimit() {
            recordLimit = parseInt(document.getElementById('recordLimit').value);
            renderTable();
        }

        function updateMetricFilter() {
            metricFilter = document.getElementById('metricFilter').value;
            renderTable();
            updateChartVisibility();
        }

        function loadUniqueNames() {
            const stored = localStorage.getItem('uniqueNames');
            if (stored) {
                uniqueNames = JSON.parse(stored);
            } else {
                // Extract unique names from existing records
                uniqueNames = [...new Set(records.map(r => r.personName).filter(name => name))];
                saveUniqueNames();
            }
        }

        function saveUniqueNames() {
            localStorage.setItem('uniqueNames', JSON.stringify(uniqueNames));
        }

        function populateNamesList() {
            const datalist = document.getElementById('namesList');
            datalist.innerHTML = uniqueNames.map(name => `<option value="${name}">`).join('');
        }

        function initCharts() {
            const bpCtx = document.getElementById('bpChart').getContext('2d');
            const sugarCtx = document.getElementById('sugarChart').getContext('2d');

            bpChart = new Chart(bpCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Systolic',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Diastolic',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Pulse',
                            data: [],
                            borderColor: 'rgb(255, 206, 86)',
                            backgroundColor: 'rgba(255, 206, 86, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Blood Pressure & Pulse Trends'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            sugarChart = new Chart(sugarCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sugar Level (mg/dL)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sugar Level Trends'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Filter non-voided records and sort by date/time
            const validRecords = records
                .filter(r => !r.isVoid)
                .sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateA - dateB;
                });

            // Update BP Chart
            const bpRecords = validRecords.filter(r => r.type === 'bp');
            const bpLabels = bpRecords.map(r => `${r.date} ${r.time}`);
            const systolicData = bpRecords.map(r => r.values.systolic);
            const diastolicData = bpRecords.map(r => r.values.diastolic);
            const pulseData = bpRecords.map(r => r.values.pulse);

            bpChart.data.labels = bpLabels;
            bpChart.data.datasets[0].data = systolicData;
            bpChart.data.datasets[1].data = diastolicData;
            bpChart.data.datasets[2].data = pulseData;
            bpChart.update();

            // Update Sugar Chart
            const sugarRecords = validRecords.filter(r => r.type === 'sugar');
            const sugarLabels = sugarRecords.map(r => `${r.date} ${r.time}`);
            const sugarData = sugarRecords.map(r => r.values.sugar);

            sugarChart.data.labels = sugarLabels;
            sugarChart.data.datasets[0].data = sugarData;
            sugarChart.update();
        }

        function updateChartVisibility() {
            const bpChartContainer = document.getElementById('bpChart').parentElement;
            const sugarChartContainer = document.getElementById('sugarChart').parentElement;

            if (metricFilter === 'all') {
                bpChartContainer.style.display = 'block';
                sugarChartContainer.style.display = 'block';
            } else if (metricFilter === 'bp') {
                bpChartContainer.style.display = 'block';
                sugarChartContainer.style.display = 'none';
            } else if (metricFilter === 'sugar') {
                bpChartContainer.style.display = 'none';
                sugarChartContainer.style.display = 'block';
            }
        }

        function saveRecords() {
            localStorage.setItem('healthRecords', JSON.stringify(records));
        }

        function loadRecords() {
            const stored = localStorage.getItem('healthRecords');
            if (stored) {
                records = JSON.parse(stored);
            }
        }

        function exportToCSV() {
            if (records.length === 0) {
                alert('No records to export!');
                return;
            }

            // CSV headers
            let csv = 'Person Name,Date,Time,Type,Systolic,Diastolic,Pulse,Sugar (mg/dL),Remarks,Is Void\n';

            // Sort by date and time
            const sortedRecords = [...records].sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateA - dateB;
            });

            // Add data rows
            sortedRecords.forEach(record => {
                const row = [
                    `"${(record.personName || '').replace(/"/g, '""')}"`,
                    record.date,
                    record.time,
                    record.type.toUpperCase(),
                    record.type === 'bp' ? record.values.systolic : '',
                    record.type === 'bp' ? record.values.diastolic : '',
                    record.type === 'bp' ? record.values.pulse : '',
                    record.type === 'sugar' ? record.values.sugar : '',
                    `"${(record.remarks || '').replace(/"/g, '""')}"`, // Escape quotes in remarks
                    record.isVoid ? 'YES' : 'NO'
                ];
                csv += row.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `health-tracker-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

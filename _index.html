<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .void-row {
            opacity: 0.5;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="text-center text-white mb-4">
            <h1 class="display-4">üíä Health Tracker</h1>
            <p class="lead">Track your blood pressure and sugar levels</p>
        </div>

        <div class="row g-4">
            <!-- Data Entry Form -->
            <div class="col-lg-4">
                <div class="card shadow sticky-lg-top" style="top: 1rem;">
                    <div class="card-header">
                        <h5 class="mb-0">üìù Record New Measurement</h5>
                    </div>
                    <div class="card-body">
                        <form id="healthForm">
                            <div class="mb-3">
                                <label for="personName" class="form-label">Person Name *</label>
                                <input type="text" class="form-control" id="personName" list="namesList" placeholder="Enter name" required autocomplete="off">
                                <datalist id="namesList"></datalist>
                            </div>

                            <div class="mb-3">
                                <label for="measurementType" class="form-label">Measurement Type *</label>
                                <select class="form-select" id="measurementType" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="bp">Blood Pressure (BP)</option>
                                    <option value="sugar">Sugar Level</option>
                                </select>
                            </div>

                            <!-- BP Fields -->
                            <div id="bpFields" class="d-none">
                                <div class="mb-3">
                                    <label class="form-label">Blood Pressure & Pulse *</label>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="systolic" placeholder="Systolic" min="0" max="300">
                                            <small class="text-muted">Top number</small>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="diastolic" placeholder="Diastolic" min="0" max="200">
                                            <small class="text-muted">Bottom number</small>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="pulse" placeholder="Pulse" min="0" max="250">
                                            <small class="text-muted">BPM</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sugar Fields -->
                            <div id="sugarFields" class="d-none">
                                <div class="mb-3">
                                    <label for="sugarLevel" class="form-label">Sugar Level (mg/dL) *</label>
                                    <input type="number" class="form-control" id="sugarLevel" placeholder="Enter sugar level" min="0" max="600">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="date" class="form-label">Date *</label>
                                <input type="date" class="form-control" id="date" required>
                            </div>

                            <div class="mb-3">
                                <label for="time" class="form-label">Time *</label>
                                <input type="time" class="form-control" id="time" required>
                            </div>

                            <div class="mb-3">
                                <label for="remarks" class="form-label">Remarks</label>
                                <textarea class="form-control" id="remarks" rows="3" placeholder="Any additional notes..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary w-100" id="submitBtn">Save Record</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- History View -->
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìä Health History</h5>
                        <button class="btn btn-light btn-sm" onclick="exportToCSV()">üíæ Export CSV</button>
                    </div>
                    <div class="card-body">
                        <!-- Charts Section -->
                        <div class="mb-4">
                            <div class="mb-4" style="height: 300px;">
                                <canvas id="bpChart"></canvas>
                            </div>
                            <div class="mb-4" style="height: 300px;">
                                <canvas id="sugarChart"></canvas>
                            </div>
                        </div>

                        <!-- Table Section -->
                        <div>
                            <div class="row g-3 mb-3 align-items-center">
                                <div class="col-auto">
                                    <label for="recordLimit" class="col-form-label">Show:</label>
                                </div>
                                <div class="col-auto">
                                    <select id="recordLimit" class="form-select form-select-sm" onchange="updateRecordLimit()">
                                        <option value="10">10</option>
                                        <option value="20" selected>20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <span class="col-form-label">records</span>
                                </div>
                                <div class="col-auto">
                                    <label for="metricFilter" class="col-form-label">Filter:</label>
                                </div>
                                <div class="col-auto">
                                    <select id="metricFilter" class="form-select form-select-sm" onchange="updateMetricFilter()">
                                        <option value="all">All Types</option>
                                        <option value="bp">BP Only</option>
                                        <option value="sugar">Sugar Only</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <div id="recordCount" class="text-muted text-end"></div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover table-striped" id="recordsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Person</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Type</th>
                                            <th>Values</th>
                                            <th>Remarks</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let records = [];
        let editingId = null;
        let bpChart = null;
        let sugarChart = null;
        let recordLimit = 20;
        let metricFilter = 'all';
        let uniqueNames = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            loadUniqueNames();
            populateNamesList();
            setDefaultDateTime();
            setupEventListeners();
            renderTable();
            initCharts();
            updateCharts();
        });

        function setupEventListeners() {
            document.getElementById('measurementType').addEventListener('change', function(e) {
                const bpFields = document.getElementById('bpFields');
                const sugarFields = document.getElementById('sugarFields');

                if (e.target.value === 'bp') {
                    bpFields.classList.remove('d-none');
                    sugarFields.classList.add('d-none');
                    document.getElementById('systolic').required = true;
                    document.getElementById('diastolic').required = true;
                    document.getElementById('pulse').required = true;
                    document.getElementById('sugarLevel').required = false;
                } else if (e.target.value === 'sugar') {
                    sugarFields.classList.remove('d-none');
                    bpFields.classList.add('d-none');
                    document.getElementById('sugarLevel').required = true;
                    document.getElementById('systolic').required = false;
                    document.getElementById('diastolic').required = false;
                    document.getElementById('pulse').required = false;
                } else {
                    bpFields.classList.add('d-none');
                    sugarFields.classList.add('d-none');
                }
            });

            document.getElementById('healthForm').addEventListener('submit', handleSubmit);
        }

        function setDefaultDateTime() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().slice(0, 5);

            document.getElementById('date').value = date;
            document.getElementById('time').value = time;
        }

        function handleSubmit(e) {
            e.preventDefault();

            const personName = document.getElementById('personName').value.trim();
            const type = document.getElementById('measurementType').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const remarks = document.getElementById('remarks').value;

            let values = {};

            if (type === 'bp') {
                values = {
                    systolic: parseInt(document.getElementById('systolic').value),
                    diastolic: parseInt(document.getElementById('diastolic').value),
                    pulse: parseInt(document.getElementById('pulse').value)
                };
            } else if (type === 'sugar') {
                values = {
                    sugar: parseInt(document.getElementById('sugarLevel').value)
                };
            }

            const record = {
                id: editingId || Date.now(),
                personName: personName,
                type: type,
                date: date,
                time: time,
                values: values,
                remarks: remarks,
                isVoid: false
            };

            if (editingId) {
                // Update existing record
                const index = records.findIndex(r => r.id === editingId);
                if (index !== -1) {
                    // Preserve void status when editing
                    record.isVoid = records[index].isVoid;
                    records[index] = record;
                }
                editingId = null;
                document.getElementById('submitBtn').textContent = 'Save Record';
            } else {
                // Add new record
                records.push(record);
            }

            // Update unique names list
            if (personName && !uniqueNames.includes(personName)) {
                uniqueNames.push(personName);
                saveUniqueNames();
                populateNamesList();
            }

            saveRecords();
            renderTable();
            updateCharts();
            resetForm();
        }

        function resetForm() {
            document.getElementById('healthForm').reset();
            document.getElementById('bpFields').classList.add('d-none');
            document.getElementById('sugarFields').classList.add('d-none');
            setDefaultDateTime();
            editingId = null;
            document.getElementById('submitBtn').textContent = 'Save Record';
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            editingId = id;

            document.getElementById('personName').value = record.personName || '';
            document.getElementById('measurementType').value = record.type;
            document.getElementById('measurementType').dispatchEvent(new Event('change'));

            if (record.type === 'bp') {
                document.getElementById('systolic').value = record.values.systolic;
                document.getElementById('diastolic').value = record.values.diastolic;
                document.getElementById('pulse').value = record.values.pulse;
            } else if (record.type === 'sugar') {
                document.getElementById('sugarLevel').value = record.values.sugar;
            }

            document.getElementById('date').value = record.date;
            document.getElementById('time').value = record.time;
            document.getElementById('remarks').value = record.remarks;

            document.getElementById('submitBtn').textContent = 'Update Record';

            // Scroll to form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function voidRecord(id) {
            const index = records.findIndex(r => r.id === id);
            if (index !== -1) {
                records[index].isVoid = !records[index].isVoid;
                saveRecords();
                renderTable();
                updateCharts();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const recordCountDiv = document.getElementById('recordCount');

            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <div>
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="64" height="64" class="mx-auto mb-3">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>No records yet. Start by adding your first measurement!</p>
                            </div>
                        </td>
                    </tr>
                `;
                recordCountDiv.textContent = '';
                return;
            }

            // Sort by date and time (newest first)
            let sortedRecords = [...records].sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateB - dateA;
            });

            // Apply metric filter
            if (metricFilter !== 'all') {
                sortedRecords = sortedRecords.filter(r => r.type === metricFilter);
            }

            // Apply pagination - show last N records
            const displayRecords = sortedRecords.slice(0, recordLimit);

            // Update record count display
            const filterText = metricFilter === 'all' ? '' : ` (${metricFilter.toUpperCase()})`;
            if (sortedRecords.length > recordLimit) {
                recordCountDiv.textContent = `Showing last ${recordLimit} of ${sortedRecords.length} records${filterText}`;
            } else if (sortedRecords.length > 0) {
                recordCountDiv.textContent = `Showing all ${sortedRecords.length} records${filterText}`;
            } else {
                recordCountDiv.textContent = `No ${metricFilter.toUpperCase()} records found`;
            }

            tbody.innerHTML = displayRecords.map(record => {
                let valuesDisplay = '';
                if (record.type === 'bp') {
                    valuesDisplay = `${record.values.systolic}/${record.values.diastolic}, Pulse: ${record.values.pulse}`;
                } else if (record.type === 'sugar') {
                    valuesDisplay = `${record.values.sugar} mg/dL`;
                }

                const typeBadgeClass = record.type === 'bp' ? 'bg-info' : 'bg-warning';
                const typeLabel = record.type === 'bp' ? 'BP' : 'Sugar';

                return `
                    <tr class="${record.isVoid ? 'void-row' : ''}">
                        <td>${record.personName || '-'}</td>
                        <td>${record.date}</td>
                        <td>${record.time}</td>
                        <td><span class="badge ${typeBadgeClass}">${typeLabel}</span></td>
                        <td>${valuesDisplay}</td>
                        <td>${record.remarks || '-'}</td>
                        <td>${record.isVoid ? '<span class="badge bg-danger">VOID</span>' : '-'}</td>
                        <td class="text-nowrap">
                            <button class="btn btn-success btn-sm" onclick="editRecord(${record.id})">Edit</button>
                            <button class="btn btn-secondary btn-sm" onclick="voidRecord(${record.id})">
                                ${record.isVoid ? 'Unvoid' : 'Void'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateRecordLimit() {
            recordLimit = parseInt(document.getElementById('recordLimit').value);
            renderTable();
        }

        function updateMetricFilter() {
            metricFilter = document.getElementById('metricFilter').value;
            renderTable();
            updateChartVisibility();
        }

        function loadUniqueNames() {
            const stored = localStorage.getItem('uniqueNames');
            if (stored) {
                uniqueNames = JSON.parse(stored);
            } else {
                // Extract unique names from existing records
                uniqueNames = [...new Set(records.map(r => r.personName).filter(name => name))];
                saveUniqueNames();
            }
        }

        function saveUniqueNames() {
            localStorage.setItem('uniqueNames', JSON.stringify(uniqueNames));
        }

        function populateNamesList() {
            const datalist = document.getElementById('namesList');
            datalist.innerHTML = uniqueNames.map(name => `<option value="${name}">`).join('');
        }

        function initCharts() {
            const bpCtx = document.getElementById('bpChart').getContext('2d');
            const sugarCtx = document.getElementById('sugarChart').getContext('2d');

            bpChart = new Chart(bpCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Systolic',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Diastolic',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Pulse',
                            data: [],
                            borderColor: 'rgb(255, 206, 86)',
                            backgroundColor: 'rgba(255, 206, 86, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Blood Pressure & Pulse Trends'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            sugarChart = new Chart(sugarCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sugar Level (mg/dL)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sugar Level Trends'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Filter non-voided records and sort by date/time
            const validRecords = records
                .filter(r => !r.isVoid)
                .sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateA - dateB;
                });

            // Update BP Chart
            const bpRecords = validRecords.filter(r => r.type === 'bp');
            const bpLabels = bpRecords.map(r => `${r.date} ${r.time}`);
            const systolicData = bpRecords.map(r => r.values.systolic);
            const diastolicData = bpRecords.map(r => r.values.diastolic);
            const pulseData = bpRecords.map(r => r.values.pulse);

            bpChart.data.labels = bpLabels;
            bpChart.data.datasets[0].data = systolicData;
            bpChart.data.datasets[1].data = diastolicData;
            bpChart.data.datasets[2].data = pulseData;
            bpChart.update();

            // Update Sugar Chart
            const sugarRecords = validRecords.filter(r => r.type === 'sugar');
            const sugarLabels = sugarRecords.map(r => `${r.date} ${r.time}`);
            const sugarData = sugarRecords.map(r => r.values.sugar);

            sugarChart.data.labels = sugarLabels;
            sugarChart.data.datasets[0].data = sugarData;
            sugarChart.update();
        }

        function updateChartVisibility() {
            const bpChartContainer = document.getElementById('bpChart').parentElement;
            const sugarChartContainer = document.getElementById('sugarChart').parentElement;

            if (metricFilter === 'all') {
                bpChartContainer.style.display = 'block';
                sugarChartContainer.style.display = 'block';
            } else if (metricFilter === 'bp') {
                bpChartContainer.style.display = 'block';
                sugarChartContainer.style.display = 'none';
            } else if (metricFilter === 'sugar') {
                bpChartContainer.style.display = 'none';
                sugarChartContainer.style.display = 'block';
            }
        }

        function saveRecords() {
            localStorage.setItem('healthRecords', JSON.stringify(records));
        }

        function loadRecords() {
            const stored = localStorage.getItem('healthRecords');
            if (stored) {
                records = JSON.parse(stored);
            }
        }

        function exportToCSV() {
            if (records.length === 0) {
                alert('No records to export!');
                return;
            }

            // CSV headers
            let csv = 'Person Name,Date,Time,Type,Systolic,Diastolic,Pulse,Sugar (mg/dL),Remarks,Is Void\n';

            // Sort by date and time
            const sortedRecords = [...records].sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateA - dateB;
            });

            // Add data rows
            sortedRecords.forEach(record => {
                const row = [
                    `"${(record.personName || '').replace(/"/g, '""')}"`,
                    record.date,
                    record.time,
                    record.type.toUpperCase(),
                    record.type === 'bp' ? record.values.systolic : '',
                    record.type === 'bp' ? record.values.diastolic : '',
                    record.type === 'bp' ? record.values.pulse : '',
                    record.type === 'sugar' ? record.values.sugar : '',
                    `"${(record.remarks || '').replace(/"/g, '""')}"`,
                    record.isVoid ? 'YES' : 'NO'
                ];
                csv += row.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `health-tracker-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
